generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum PropertyType {
  Apartment
  House
  Villa
  Office
  Commercial
  Land
  Building
  Studio
  Duplex
  ChambreModerne
  Chambre
}

enum UserRole {
  USER
  AGENT
  ADMIN
}

enum OTPType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  LOGIN_VERIFICATION
}

enum MediaEntityType {
  PROPERTY
  LOTISSEMENT
  PARCELLE
  BATIMENT
  INFRASTRUCTURE
}

// ============================================
// Authentication Models
// ============================================

model OTPToken {
  id        String   @id @default(uuid())
  email     String
  token     String
  type      OTPType
  expires   DateTime
  createdAt DateTime @default(now())
  
  @@unique([email, token])
  @@index([email, expires])
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  password      String?
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  
  accounts      Account[]
  sessions      Session[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Geographic Models (Optimized)
// ============================================

model Region {
  Id_Reg        Int           @id @default(autoincrement())
  Nom_Reg       String?
  Sup_Reg       Float?
  Chef_lieu_Reg String?
  WKT_Geometry  String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  departements  Departement[]
  
  @@index([Nom_Reg])
}

model Departement {
  Id_Dept         Int              @id @default(autoincrement())
  Nom_Dept        String?
  Sup_Dept        Float?
  Chef_lieu_Dept  String?
  Id_Reg          Int?
  WKT_Geometry    String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  region          Region?          @relation(fields: [Id_Reg], references: [Id_Reg])
  arrondissements Arrondissement[]
  
  @@index([Id_Reg])
  @@index([Nom_Dept])
}

model Arrondissement {
  Id_Arrond        Int           @id @default(autoincrement())
  Nom_Arrond       String?
  Sup_Arrond       Float?
  Chef_lieu_Arrond String?
  Commune          String?
  Id_Dept          Int?
  WKT_Geometry     String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  departement      Departement?  @relation(fields: [Id_Dept], references: [Id_Dept])
  lotissements     Lotissement[]
  
  @@index([Id_Dept])
  @@index([Nom_Arrond])
}

// ============================================
// Property-Related Models (Optimized)
// ============================================

model Lotissement {
  Id_Lotis       Int             @id @default(autoincrement())
  Nom_proprio    String?
  Num_TF         String?
  Statut         String?
  Nom_cons       String?
  Surface        Float?
  Nom_visa_lotis String?
  Date_approb    DateTime?       @db.Date
  Geo_exe        String?
  Nbre_lots      Int?
  Lieudit        String?
  Echelle        Int?
  Ccp            String?
  Id_Arrond      Int?
  WKT_Geometry   String?         @db.Text
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  arrondissement Arrondissement? @relation(fields: [Id_Arrond], references: [Id_Arrond])
  parcelles      Parcelle[]
  limitrophes    Limitrophe[]
  media          Media[]
  
  @@index([Id_Arrond])
  @@index([Num_TF])
  @@index([Statut])
}

model Parcelle {
  Id_Parcel    Int          @id @default(autoincrement())
  Nom_Prop     String?
  TF_Mere      String?
  Mode_Obtent  String?
  TF_Cree      String?
  Nom_Cons     String?
  Sup          Float?
  Nom_Visa_Cad String?
  Date_visa    DateTime?    @db.Date
  Geometre     String?
  Date_impl    DateTime?    @db.Date
  Num_lot      String?
  Num_bloc     String?
  Lieu_dit     String?
  Largeur_Rte  String?
  Echelle      Int?
  Ccp_N        String?
  Mise_Val     Boolean?
  Cloture      Boolean?
  Id_Lotis     Int?
  WKT_Geometry String?      @db.Text
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  properties   Property[]
  lotissement  Lotissement? @relation(fields: [Id_Lotis], references: [Id_Lotis])
  batiments    Batiment[]
  payers       Payer[]
  contenirs    Contenir[]
  trouvrs      Trouver[]
  eclairers    Eclairer[]
  desservirs   Desservir[]
  media        Media[]
  
  @@index([Id_Lotis])
  @@index([TF_Cree])
  @@index([Num_lot])
}

model Batiment {
  Id_Bat       Int       @id @default(autoincrement())
  Type_Usage   String?
  Cat_Bat      String?
  Status       String?
  Standing     String?
  Cloture      Boolean?
  No_Permis    String?
  Type_Lodg    String?
  Etat_Bat     String?
  Nom          String?
  Mat_Bati     String?
  
  // Building-level metrics only
  totalFloors   Int?
  totalUnits    Int?
  hasElevator   Boolean?  @default(false)
  surfaceArea   Float?
  doorNumber    String?
  address       String?   @db.Text
  
  Id_Parcel     Int?
  WKT_Geometry  String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  properties      Property[]
  parcelle        Parcelle?        @relation(fields: [Id_Parcel], references: [Id_Parcel])
  payers          Payer[]
  alimenters      Alimenter[]
  approvisionners Approvisionner[]
  media           Media[]
  
  @@index([Id_Parcel])
  @@index([Type_Usage])
  @@index([Standing])
}

// ============================================
// Centralized Property Model (Main Listing)
// ============================================

model Property {
  id                    Int          @id @default(autoincrement())
  title                 String
  shortDescription      String?      @db.VarChar(500)
  description           String?      @db.Text
  
  // Pricing - ONLY HERE, not duplicated
  price                 Decimal?     @db.Decimal(15, 2)
  priceMin              Decimal?     @db.Decimal(15, 2)
  priceMax              Decimal?     @db.Decimal(15, 2)
  pricePerSqM           Decimal?     @db.Decimal(15, 2)
  currency              String       @default("XAF")
  
  // Listing type
  type                  PropertyType
  forSale               Boolean      @default(true)
  forRent               Boolean      @default(false)
  rentPrice             Decimal?     @db.Decimal(15, 2)
  
  // Land specifics
  isLandForDevelopment  Boolean      @default(false)
  approvedForApartments Boolean?
  
  // Unit features (apartment/house specific)
  bedrooms              Int?
  bathrooms             Int?
  kitchens              Int?
  livingRooms           Int?
  surfaceArea           Float?
  floorLevel            Int?
  totalFloors           Int?
  doorNumber            String?
  
  // Amenities
  hasGenerator          Boolean?     @default(false)
  hasParking            Boolean?     @default(false)
  parkingSpaces         Int?
  amenities             String?      @db.Text
  
  // Location
  address               String?      @db.Text
  parcelleId            Int
  batimentId            Int?
  
  // Relations
  parcelle              Parcelle     @relation(fields: [parcelleId], references: [Id_Parcel])
  batiment              Batiment?    @relation(fields: [batimentId], references: [Id_Bat])
  media                 Media[]
  
  // Status
  published             Boolean      @default(false)
  featured              Boolean      @default(false)
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  @@index([parcelleId])
  @@index([batimentId])
  @@index([type])
  @@index([price])
  @@index([priceMin, priceMax])
  @@index([published, featured])
  @@index([forSale, forRent])
  @@index([createdAt])
}

// ============================================
// Centralized Media Model
// ============================================

model Media {
  id          Int              @id @default(autoincrement())
  entityType  MediaEntityType
  entityId    Int
  url         String
  type        String           // 'image' or 'video'
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Polymorphic relations
  property       Property?       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId     Int?
  lotissement    Lotissement?    @relation(fields: [lotissementId], references: [Id_Lotis], onDelete: Cascade)
  lotissementId  Int?
  parcelle       Parcelle?       @relation(fields: [parcelleId], references: [Id_Parcel], onDelete: Cascade)
  parcelleId     Int?
  batiment       Batiment?       @relation(fields: [batimentId], references: [Id_Bat], onDelete: Cascade)
  batimentId     Int?
  infrastructure Infrastructure? @relation(fields: [infrastructureId], references: [Id_Infras], onDelete: Cascade)
  infrastructureId Int?
  
  @@index([entityType, entityId])
  @@index([propertyId])
  @@index([order])
}

// ============================================
// Infrastructure & Utilities
// ============================================

model Route {
  Id_Rte       Int         @id @default(autoincrement())
  Cat_Rte      String?
  Type_Rte     String?
  Largeur_Rte  String?
  Etat_Rte     String?
  Mat_Rte      String?
  WKT_Geometry String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  desservirs   Desservir[]
  
  @@index([Type_Rte])
}

model Riviere {
  Id_Riv       Int          @id @default(autoincrement())
  Nom_Riv      String?
  Type_Riv     String?
  Etat_amenag  String?
  Debit_Riv    String?
  WKT_Geometry String?      @db.Text
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  limitrophes  Limitrophe[]
}

model Taxe_immobiliere {
  Id_Taxe       Int       @id @default(autoincrement())
  Num_TF        String?
  Nom_Proprio   String?
  NIU           String?
  Val_imm       Float?
  Taxe_Payee    Boolean?
  Date_declaree DateTime? @db.Date
  Type_taxe     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  payers        Payer[]
  
  @@index([Num_TF])
  @@index([NIU])
}

model Equipement {
  Id_Equip     Int        @id @default(autoincrement())
  Type_Equip   String?
  Design_Equip String?
  Etat_Equip   String?
  Mat_Equip    String?
  WKT_Geometry String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  eclairers    Eclairer[]
}

model Reseau_energetique {
  Id_Reseaux   Int         @id @default(autoincrement())
  Source_Res   Float?
  Type_Reseau  String?
  Etat_Res     String?
  Materiau     String?
  WKT_Geometry String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  alimenters   Alimenter[]
}

model Reseau_en_eau {
  Id_Reseaux      Int              @id @default(autoincrement())
  Source_Res      Float?
  Type_Res        String?
  Etat_Res        String?
  Mat_Res         String?
  WKT_Geometry    String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  approvisionners Approvisionner[]
}

model Infrastructure {
  Id_Infras        Int       @id @default(autoincrement())
  Nom_infras       String?
  Type_Infraas     String?
  Categorie_infras String?
  Cycle            String?
  Statut_infras    String?
  Standing         String?
  WKT_Geometry     String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  trouvrs          Trouver[]
  media            Media[]
  
  @@index([Type_Infraas])
  @@index([Nom_infras])
}

model Borne {
  Id_Borne     Int        @id @default(autoincrement())
  coord_x      Float?
  coord_y      Float?
  coord_z      Float?
  WKT_Geometry String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  contenirs    Contenir[]
}

// ============================================
// Relationship Models (with optimized indexes)
// ============================================

model Payer {
  Id_Parcel Int
  Id_Bat    Int
  Id_Taxe   Int
  date_paye Int?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  parcelle Parcelle         @relation(fields: [Id_Parcel], references: [Id_Parcel], onDelete: Cascade)
  batiment Batiment         @relation(fields: [Id_Bat], references: [Id_Bat], onDelete: Cascade)
  taxe     Taxe_immobiliere @relation(fields: [Id_Taxe], references: [Id_Taxe], onDelete: Cascade)

  @@id([Id_Parcel, Id_Bat, Id_Taxe])
  @@index([Id_Taxe])
}

model Limitrophe {
  Id_Lotis  Int
  Id_Riv    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lotissement Lotissement @relation(fields: [Id_Lotis], references: [Id_Lotis], onDelete: Cascade)
  riviere     Riviere     @relation(fields: [Id_Riv], references: [Id_Riv], onDelete: Cascade)

  @@id([Id_Lotis, Id_Riv])
  @@index([Id_Riv])
}

model Alimenter {
  Id_Bat     Int
  Id_Reseaux Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  batiment          Batiment           @relation(fields: [Id_Bat], references: [Id_Bat], onDelete: Cascade)
  reseauEnergetique Reseau_energetique @relation(fields: [Id_Reseaux], references: [Id_Reseaux], onDelete: Cascade)

  @@id([Id_Bat, Id_Reseaux])
  @@index([Id_Reseaux])
}

model Contenir {
  Id_Parcel Int
  Id_Borne  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parcelle Parcelle @relation(fields: [Id_Parcel], references: [Id_Parcel], onDelete: Cascade)
  borne    Borne    @relation(fields: [Id_Borne], references: [Id_Borne], onDelete: Cascade)

  @@id([Id_Parcel, Id_Borne])
  @@index([Id_Borne])
}

model Trouver {
  Id_Parcel Int
  Id_Infras Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parcelle       Parcelle       @relation(fields: [Id_Parcel], references: [Id_Parcel], onDelete: Cascade)
  infrastructure Infrastructure @relation(fields: [Id_Infras], references: [Id_Infras], onDelete: Cascade)

  @@id([Id_Parcel, Id_Infras])
  @@index([Id_Infras])
}

model Eclairer {
  Id_Parcel Int
  Id_Equip  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parcelle   Parcelle   @relation(fields: [Id_Parcel], references: [Id_Parcel], onDelete: Cascade)
  equipement Equipement @relation(fields: [Id_Equip], references: [Id_Equip], onDelete: Cascade)

  @@id([Id_Parcel, Id_Equip])
  @@index([Id_Equip])
}

model Desservir {
  Id_Parcel Int
  Id_Rte    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parcelle Parcelle @relation(fields: [Id_Parcel], references: [Id_Parcel], onDelete: Cascade)
  route    Route    @relation(fields: [Id_Rte], references: [Id_Rte], onDelete: Cascade)

  @@id([Id_Parcel, Id_Rte])
  @@index([Id_Rte])
}

model Approvisionner {
  Id_Bat     Int
  Id_Reseaux Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  batiment    Batiment      @relation(fields: [Id_Bat], references: [Id_Bat], onDelete: Cascade)
  reseauEnEau Reseau_en_eau @relation(fields: [Id_Reseaux], references: [Id_Reseaux], onDelete: Cascade)

  @@id([Id_Bat, Id_Reseaux])
  @@index([Id_Reseaux])
}